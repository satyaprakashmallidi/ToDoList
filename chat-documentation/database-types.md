# Database Types - Chat Related Tables

## File Location
`src/types/database.ts` (extracted chat-related portions)

## Purpose
Database schema type definitions generated by Supabase for chat-related tables, ensuring type safety when interacting with the database.

## Table Definitions

### chat_groups
Stores information about chat groups.
```typescript
chat_groups: {
  Row: {
    id: string                  // Unique group identifier (UUID)
    name: string                // Group display name
    description: string | null  // Optional group description
    admin_id: string            // User ID of group creator/admin
    avatar_url: string | null   // Optional group avatar image
    is_active: boolean          // Soft delete flag
    created_at: string | null   // Creation timestamp
    updated_at: string | null   // Last update timestamp
  }
}
```
**Purpose**: Central group metadata storage
**Relationships**: 
- `admin_id` → `profiles.id`
- One-to-many with `chat_group_members`
- One-to-many with `group_messages`

### chat_group_members
Junction table for group membership.
```typescript
chat_group_members: {
  Row: {
    id: string                    // Unique membership record ID
    group_id: string              // Reference to chat group
    user_id: string               // Reference to user profile
    role: 'admin' | 'member'      // User's role in the group
    joined_at: string | null      // Timestamp when user joined
    left_at: string | null        // Timestamp when user left (if applicable)
    is_active: boolean            // Active membership status
  }
}
```
**Purpose**: Manages group membership and roles
**Relationships**:
- `group_id` → `chat_groups.id`
- `user_id` → `profiles.id`
**Constraints**: Unique combination of (group_id, user_id)

### group_messages
Stores all messages within groups.
```typescript
group_messages: {
  Row: {
    id: string                              // Unique message ID
    group_id: string                        // Group this message belongs to
    sender_id: string                       // User who sent the message
    content: string                         // Message text content
    message_type: 'text' | 'image' | 'file' | 'system'  // Type of message
    file_url: string | null                 // URL for file/image messages
    file_name: string | null                // Original filename
    file_size: number | null                // File size in bytes
    reply_to_id: string | null              // ID of message being replied to
    is_edited: boolean                      // Edit status flag
    is_deleted: boolean                     // Soft delete flag
    created_at: string                      // Message timestamp
    updated_at: string                      // Last edit timestamp
  }
}
```
**Purpose**: Message storage with support for various content types
**Relationships**:
- `group_id` → `chat_groups.id`
- `sender_id` → `profiles.id`
- `reply_to_id` → `group_messages.id` (self-reference)

## Database Features

### Row Level Security (RLS)
All tables use RLS policies to ensure:
- Users can only see groups they're members of
- Users can only see messages in their groups
- Only admins can delete groups
- Members can only modify their own messages

### Indexes
Optimized for common queries:
- `chat_group_members`: (group_id, user_id)
- `group_messages`: (group_id, created_at)
- `group_messages`: (sender_id)

### Triggers
- Auto-update `updated_at` timestamps
- Cascade deletes for group deletion
- Member count maintenance

## RPC Functions

### get_user_chat_groups
Returns all groups a user is a member of with metadata.

### get_group_messages_with_profiles
Fetches messages with sender profile information joined.

### create_chat_group
Creates a new group and adds initial members.

### delete_chat_group
Safely deletes a group (admin only).

### get_user_team_members
Returns team members available for group creation.

## Data Flow

1. **Group Creation**:
   - Insert into `chat_groups`
   - Add creator to `chat_group_members` as admin
   - Add other members to `chat_group_members`

2. **Message Sending**:
   - Insert into `group_messages`
   - Real-time broadcast to group members
   - Update group's last message metadata

3. **Group Deletion**:
   - Soft delete in `chat_groups` (is_active = false)
   - Deactivate all memberships
   - Messages retained for history

## Type Safety Benefits
- Compile-time validation of database queries
- IntelliSense for column names
- Prevents SQL injection through typed parameters
- Ensures data consistency across application